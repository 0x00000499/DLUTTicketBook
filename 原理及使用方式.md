+ 简介

因为大工体育场馆的位置有限，所以有些热门的场馆比如篮球馆或者羽毛球场馆的预定非常困难。本来资源就不多还有一些需要留给内部人员使用的场地。所以订票就是个很大的问题。所以当前代码实现了在特定时间去代替人力来进行体育场馆预定的功能。 同时为了避免一些内部通道预定对时间选择上造成的干扰，代码也提供了特定时间的可用场地查询功能。总体功能清单如下：

+ 目前支持的场地类型：篮球馆/乒乓球/羽毛球场馆
+ 查询特定日期内空闲时间和空闲场地
+ 自动根据订购日期 即时/定时 发起订购
    - 可以有多种时间组合，比如（12:00，12:30）或者（13:00，13:30）
    - 可以有单个种类多个场地选择，比如羽毛球的 1，2，3 号场地
    - 支持微信/支付宝/玉兰卡支付

# 工作流程
## 实现原理
在实际的分析过程中，发现体育场馆的预定系统算是独立于校园门户的一个功能。唯一用到的就是校园门户的认证功能。而且从 i 大工和网页端的界面来看，这个预定系统基本是采用的前后端分离的方式进行开发的。所以可以通过模拟浏览器端发送 HTTP 请求的方式来实现自动订票。这就需要对系统整体的请求过程有一个大致的了解。如果想要自己去看实际请求的过程的话，需要先保证清除所有浏览器的缓存及 Cookie，这样才能反应出一个完整的请求过程。可以通过按 F12 打开开发者工具查看所有的请求。

### 认证过程
体育馆场馆预定的 URL 是：`http://adm-tycg.dlut.edu.cn/api/login/login`

但是如果清除所有浏览器 Cookie 后即没有认证的时候去访问这个链接，会首先要求进行登陆，重定向到达 `http://sso.dlut.edu.cn/cas/login`进行统一身份认证。

![](https://cdn.nlark.com/yuque/0/2023/png/36180460/1700727538759-b33d421f-984a-4ba4-a632-12b1f7099ba0.png)

当重定向到统一身份认证界面的时候，服务器会自动响应一个 Cookie `JSESSIONCASID`，后续需要携带该 Cookie 进行认证接下来的操作。

![](https://cdn.nlark.com/yuque/0/2023/png/36180460/1700727073564-1b2cec25-7a2e-42e5-94e2-e117c27f1beb.png)

输入账号密码之后会进行登陆进入体育场馆预定的主系统，在这个过程中会有两个关键的认证请求。

![](https://cdn.nlark.com/yuque/0/2023/png/36180460/1700727484809-4ca1b0b6-8f04-4c7b-985b-4601a5412118.png)

第一个请求用来申请一个 Cookie`CASTGC`，以及一个服务授权申请 `Ticket`URL。 这个过程中需要用到统一身份认证的账号和密码，作为一个`POST`请求，其请求体中就包含了账号和密码等信息，但是请求过程会对账号密码进行加密，加密的过程在`JS`文件中有所体现，可以自行查看。

在请求体中会有一个参数是 lt ，加密的时候也要用到，该值在每一次登陆的时候都需要重新从前端界面获取。该参数在前端界面中是以隐藏表单的形式存在的，如下图所示。

![](https://cdn.nlark.com/yuque/0/2023/png/36180460/1700730955043-aba247f7-2d98-4a31-aa5d-bb034457af90.png)

```json
{rsa: 137ED31B23AA8AEB46D3DFC57AA4EDE4EC431EE9D723B1BB777AD270C57DE641BD3E968AA89B0D4D260FB355FF6EE812145695E4FB4ADF1D451F1C1644BFD75F1FF262323B4A3C2199CE5432CE3B945BA7534BCFC443B3050A34A36905D866756A0F2D28DF65CF4CFBB5B1A7B3551D5910D2A86B649C6E39019FCB764FCF1E13B2DA8880EA270330
  // rsa加密,desutil(学号密码lt,1,2,3),是一个现成的加密算法，三个密钥是1，2，3
  // 账号长度
  ul: 8
  // 密码长度
  pl: 14
  // 不知道是什么
  sl: 0
  // lt来自前端文件
  lt: LT-15822-pp4Lk9HNkmNgzRRgzzCcyZzFplGEmv-cas
  // 剩下两个参数都是一样的
  execution: e1s1
  _eventId: submi
}
```

![](https://cdn.nlark.com/yuque/0/2023/png/36180460/1700728281086-dcff0707-7f6a-4f6f-a4d3-f3e06d0ce1a7.png)

![](https://cdn.nlark.com/yuque/0/2023/png/36180460/1700728175841-8dc653f7-6242-4f55-b0c0-79a8a83a1d29.png)

当拿到带有`Ticket`的 URL 请求之后，直接向该 URL 发送一个 `GET`请求就可以获取到访问场馆预定的服务 token 后续的所有请求携带该 token 即可。

![](https://cdn.nlark.com/yuque/0/2023/png/36180460/1700728478244-5758542d-7d01-4b54-9fed-4f3c7c736fef.png)

### 下订单过程
下订单的过程实际上只涉及到两个接口，一个是查询当前的票量剩余，一个是创建订单。上述的两个过程都需要携带第一步所申请到的 token

查询场地票务信息的接口是`http://adm-tycg.dlut.edu.cn/api/court/getCourtPrice?product_id=78&venue_id=236&date=2023-11-23`其中有几个查询参数，需要根据你查询到场地类型和时间来进行设置。发起该请求后就可以得到各个时间段的场地信息，空闲状态价格等信息。这些信息可以暂时存储起来等到创建订单的时候使用。

![](https://cdn.nlark.com/yuque/0/2023/png/36180460/1700728706247-f1ffaab9-8312-40f4-8579-a6f01d1b238e.png)

```json
{
    "code": 1,
    "info": "获取成功",
    "data": {
        "result": [
            {
              
                "id": 880,
                "start_time": "15:00",
                "end_time": "15:30",
              // 这个参数也是会变化的周末和工作日就是不一样的所以不能写死
                "meal_id": 128, 
                "isToday": 1,
              // 分别按顺序对应每一个场地
                "fieldlist_s": [
                    {
                      // 这种是已经被订购完了
                      // lock是0的时候是学生订购的，lock是1的时候一般提前好多天就已经被锁定了，估计是上课什么的，只有false的时候才是学生可以订购的。所以抢的时候一定要先查询哪些是可以订的。
                        "text": "",
                        "lock": 1,
                        "price_id": 8773
                    },
                    ...
                ]
            },
            .....// 都是上下这种类似的结构
            {
                "id": 1024,
                "start_time": "21:00",
                "end_time": "21:30",
                "meal_id": 128,
                "isToday": 1,
                // 这种是可以订购的
                "fieldlist_s": [
                    {
                        "price_id": 9231,
                        "field_id": "342",
                        "time_id": 1024,
                        "hasNum": null,
                        "select": false,
                        "field_type": "1",
                        "timeprice": "12.00元\/场(1\/1 场)",
                        "time_price": "12.00",
                        "vip_0_price_text": "12.00元\/场",
                        "vip_0_price": "12.00",
                        "text": 1,
                        "leftNum": 1,
                        "lock": false
                    },
                  	...
                ]
            }
        ],
       // ...不重要的信息
}
```

创建订单的接口是`http://adm-tycg.dlut.edu.cn/api/pay/CreateOrder`，这个过程请求头中依旧要携带之前申请到的 token。具体的请求体中有几个参数，可以自行查看其具体的请求内容。其中一个参数是支付方法，**3** 代表的是使用微信/支付宝支付，采用这种方式的话订购成功重定向到付款界面。**1** 代表的是使用玉兰卡支付，如果采用玉兰卡支付的话会直接扣款完成支付过程。

![](https://cdn.nlark.com/yuque/0/2023/png/36180460/1700729394322-facc7855-d455-40f9-b04c-f07d15e5a529.png)

```json
{"goods_id":"78", // 商品Id可以根据请求的场地类型自己查询
  "order_type":3, // 订单类型固定
  "pay_way":"3", // 1是玉兰卡支付，3是微信/支付宝支付
  "other_param": // 具体的订单内容，这些参数都可以从前面的场地信息获取
  "{\"price_ids\":\"9236\",\"time_ids\":\"1024\",\"field_ids\":\"405\",\"price\":\"20.00\",\"court_id\":\"78\",\"meal_id\":129,\"field_type\":\"1\"}",
  "choose_date":"2023-11-19" // 订单的日期}
```

除此之外还有一个查询接口是用来查询场地的详细信息的其 URL 是`http://adm-tycg.dlut.edu.cn/api/court/getFieldNoList?product_id=80`，比如其名称和 id。因为下订单以及票量查询的时候都是采用的场地的 id，不知道场地的具体名称，为了更好的显示，才有了该接口。

```json
{
    "code": 1,
    "info": "获取成功",
    "data": {
        "result": [
            {
                "id": 342,
                "seat_number": "1号场半场1"
            },
            ...
        ]
    }
}
```

如果运行成功会出现下面的结果，当前采用的是微信/支付宝的支付方式，如果订购成功的话会返回一个支付链接，点击该链接就会进入付款界面，付款后其实就成功订购了。如果订购失败会有信息提示。但是有一点需要注意的是，当前场地预定并没有提供退单的接口和功能，所以如果采用微信支付的方式下了订单但是没有支付的话，个人订单记录里面还是会有这次订单记录。这个人的账户就不能再订购当天这个时间段这个类型场地的票了，其他时间和场地是不影响的。所以微信支付的方式适合用来做功能测试。微信支付抢票成功是下面的结果：

![](https://cdn.nlark.com/yuque/0/2023/png/36180460/1700792708244-cabb8a67-8a81-4534-87f5-7a6fac749457.png)

如果是选择采用玉兰卡支付的方式，发起订单后会直接从玉兰卡中扣钱，订单会直接完成，所以适用于正式抢票的时候，抢票成功后会显示下面的结果。

![](https://cdn.nlark.com/yuque/0/2023/png/36180460/1700876981647-569f2dd9-c02c-412c-9f3b-6d7f03fab0f5.png)

### 查询功能
因为可能会有一些校队训练的情况会提前占用一些时间，这些时间是肯定不能被订购的，所以本代码提供了可用时间查询功能。基本原理就是采用了上面的查询票务信息接口，然后对输出数据进行格式化。如果查询成功会得到相应的结果如下图所示：

![](https://cdn.nlark.com/yuque/0/2023/png/36180460/1700878182689-0946578e-ed06-409a-ab4e-d65d29ca21a9.png)

## 程序流程图
![画板](https://cdn.nlark.com/yuque/0/2023/jpeg/36180460/1700725812311-f9480eb9-5a52-4a1c-b745-4ff1f76adb59.jpeg)

# 使用方法
## <font style="color:#DF2A3F;">时间校准（重要）</font>
在使用该程序的时候因为需要在特定的时间程序自动启动，所以对时间的准确性有着很高的要求。所以在**启动程序前**务必要调整好系统时间，一般通过时间服务器自动设置时间的方式就可以。将系统时间设置准确后再启动程序进行执行。

另一点是本程序提供了空闲场地查询的功能，**<font style="color:#DF2A3F;background-color:#FBDE28;">请在选择订购场地前先通过查询功能查询出可以订购的场地，然后再进行订购</font>**，可以显著提高成功率。

## 源代码直接执行
使用的时候关键配置就是在修改配置文件上，如果是采用源代码的方式执行的话，需要在 application.yml 所在路径下新建一个 application-dev.yml 文件，文件的内容和 application.yml 基本一致，但是需要删除和修改一部分东西，具体路径和内容如下：

![](https://cdn.nlark.com/yuque/0/2023/png/36180460/1700791926690-521452d8-96e2-4641-949d-d24475cbe5a9.png)

```yaml
#############认证相关配置#############
dlut:
  username: # 学号
  password: # 统一身份认证的密码
  keys: # 这三个是认证的加密密钥，必须是1，2，3不能修改
    firstKey: 1 
    secondKey: 2
    thirdKey: 3
###########订购相关参数################
  sport: pingPong # basketball/pingPong/badminton （羽毛球） 目前实现了这三个，区分大小写
  start_time: '20:00,20:30|21:00,21:30' 
# '10:00,11:00....' 按照网页上展示的开始时间进行设置必须准确, 且格式必须准确'time,time,time|time,time,time'。在订购过程中，会看这些时间段是否有空闲场地，就算只有一个时间段内不能满足订购需求，都认为该订购需求不能满足，会继续查看后一个订购时间组合。如果所有的时间需求组合都不能满足的话会认为当前抢票任务就是失败了。
# |分隔符用来分隔时间组合，比如19:00,20:00|18:00,19:00,20:00代表的是代表7-9点或者6-9点的场地，匹配的时候优先从左侧开始匹配，会先看能否满足7-9点，如果任一时间不满足，则匹配6-9点的场地，如果匹配成功，则抢票，否则失败。
# 抢票过程会判断当前时间段任一满足要求的场地，只要有一个court中设置的场地能够满足时间要求，都认为该场地是满足要求的。所以可能会出现6-9点的票不在同一个场地的情况。
  court: 15,16,17  # 按照网页展示顺序从左到右 0,1,2... ,抢票的时候会依次看某个时间段内这些场地是否空闲，但是最终每个时间段只会选择一个场地。比如1号场地编号就是0，2号场地编号就是1，以此类推。
  pay_method: 3 # 3是微信或者支付宝支付,1是玉兰卡支付
  retries: 10 # 订票失败重试次数
  mode: book # query / book，因为体育馆可能会有校队训练，所以一些时间内场地是不能预定的。为了区分出哪些场地可以预定，所以这个系统分为了查询和订购两个功能。当开启query模式的时候，订购相关的参数中只有date日期会生效，运行程序会查询该日期的哪些时间段的哪些场次是可以预定的，后续开启订购功能的时候一定要订那些可以订购的部分。如果是开启了book模式，则所有的参数都会按照对应的设置生效。
  date: 2023-11-25
```

## java 直接执行方式
配置文件的修改方式和参数内容和上面一致，可以自己新建一个 application-dev.yaml 文件，只要保证二者在一个路径下即可。 只不过需要电脑上装有 java，最低得是 java8 版本。然后在当前文件打开命令行（MacOS bash/Windows CMD） 执行`java -jar DLUT....jar（打包好的 jar 文件）`等待结果就可以了。jar 文件可以从 [github](https://github.com/0x00000499/DLUTTicketBook/releases) 上获取。

![](https://cdn.nlark.com/yuque/0/2023/png/36180460/1700794310503-158a422d-d3e9-48d5-8071-156ea798b910.png)







